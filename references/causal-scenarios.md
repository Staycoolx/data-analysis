# 因果推断典型业务场景库

> 本文档汇总常见的因果推断业务场景，给出每种场景的适用方法、数据要求、分析模板。

---

## 场景1：推荐系统升级效果评估

### 业务问题
「推荐系统升级后，用户留存/转化率提升了，这个提升是算法带来的还是自然增长？」

### 适用方法
**DID（双重差分）**

### 数据要求
| 字段 | 说明 |
|------|------|
| 时间变量 | 用户注册/行为日期 |
| 分组变量 | 渠道/版本（处理组 vs 对照组） |
| 结果变量 | 留存率、转化率、点击率等 |
| 协变量（可选） | 用户特征、渠道特征等 |

### 分析模板
```bash
python3 scripts/analyze_did.py data.csv \
    --treatment channel \
    --outcome retention_d1 \
    --time register_date \
    --group user_id \
    --output recommendation_upgrade_report
```

### 关键假设检验
- 平行趋势假设：升级前两组趋势一致
- 检验方法：Event Study 图、伪treatment检验

### 输出解读
- DID效应 = 升级后留存变化 - 假设未升级的留存变化
- 如果显著为正：升级有效，建议推广
- 如果不显著：可能需要更多数据或优化策略

---

## 场景2：新用户补贴/红包效果

### 业务问题
「发放新用户红包/补贴后，用户首单/复购率提升了，补贴的ROI是多少？」

### 适用方法
- **PSM（倾向得分匹配）**：有用户特征可用
- **DID（双重差分）**：有对照组（未补贴用户）

### 数据要求
| 字段 | 说明 |
|------|------|
| 是否领取补贴 | 处理组标识 |
| 用户特征 | 年龄、渠道、设备、行为等 |
| 结果变量 | 首单转化、7日复购、GMV等 |
| 时间变量 | 领取/注册时间 |

### 分析模板
```python
# PSM 分析
from sklearn.linear_model import LogisticRegression
from sklearn.neighbors import NearestNeighbors

# 1. 估计倾向得分
ps_model = LogisticRegression()
ps_model.fit(X_features, treatment)
propensity_scores = ps_model.predict_proba(X_features)[:, 1]

# 2. 匹配
# ... (详见 causal-inference.md)

# 3. 计算ATT
att = outcome[treatment==1].mean() - outcome[matched_control].mean()
```

### 输出解读
- ATT（Average Treatment Effect on the Treated）：补贴对领取用户的效果
- ROI = (额外收益 - 补贴成本) / 补贴成本

---

## 场景3：会员权益价值评估

### 业务问题
「会员权益（免运费、专属折扣等）到底带来了多少额外价值？」

### 适用方法
**PSM（倾向得分匹配）**

### 分析思路
1. 会员 vs 非会员 直接对比有偏差（选择偏差）
2. 用 PSM 为会员匹配相似的非会员
3. 比较两组的后续行为

### 常见指标
- 续费率
- ARPU（用户平均收入）
- 活跃天数
- 生命周期价值（LTV）

---

## 场景4：达到阈值奖励的效果

### 业务问题
「用户累计消费满1000元送优惠券，这个阈值策略有效吗？」

### 适用方法
**RDD（断点回归）**

### 数据要求
| 字段 | 说明 |
|------|------|
| 运行变量 | 累计消费金额 |
| 阈值 | 1000元 |
| 处理变量 | 是否达到阈值 |
| 结果变量 | 后续消费、复购等 |

### 分析要点
- 只看阈值附近的用户（局部效应）
- 检验在阈值处是否有跳跃

### 代码示例
```python
from rdrobust import rdrobust

# 距离阈值最近的样本
df_near = df[(df['spend'] >= threshold - bandwidth) &
             (df['spend'] <= threshold + bandwidth)]

result = rdrobust(y=df_near['outcome'],
                  x=df_near['spend'] - threshold)
```

---

## 场景5：城市/区域政策效果

### 业务问题
「某城市实施了新政策，对经济/环境指标的影响是什么？」

### 适用方法
**合成控制法（Synthetic Control Method）**

### 数据要求
| 字段 | 说明 |
|------|------|
| 处理单位 | 政策实施城市 |
| 对照单位 | 未实施政策的城市 |
| 时间维度 | 月度/季度/年度面板数据 |
| 结果变量 | GDP、污染指数、房价等 |

### 分析要点
- 用多个对照城市加权合成"虚拟对照"
- 检验处理效应是否显著

---

## 场景6：功能上线A/B测试

### 业务问题
「新功能上线，效果如何？是否全量？」

### 适用方法
- **AB Test（实验）**：如果随机分配
- **DID**：如果无法严格随机，用自然实验

### AB Test 分析
```python
from scipy import stats

# 两组转化率
conv_a = successes_a / n_a
conv_b = successes_b / n_b

# 显著性检验
z_stat, p_value = stats.proportions_ztest([successes_a, successes_b],
                                           [n_a, n_b])
```

### DID 作为补充
- AB Test 结束后，用 DID 验证长期效应
- 检查是否有溢出效应

---

## 场景7：渠道效果对比

### 业务问题
「不同获客渠道的用户质量差异有多大？」

### 适用方法
- **PSM**：匹配相似用户后对比
- **DID**：如果有策略变化的自然实验

### 常用指标
- 次日/7日/30日留存
- 首单转化率
- 首单GMV
- 用户生命周期价值

---

## 场景8：搜索/推荐策略优化

### 业务问题
「搜索排序优化后，点击率/成交率提升了，优化效果多大？」

### 适用方法
**PSM/DID**

### 分析注意
- 搜索/推荐场景用户有自选择偏差
- 需要用用户历史特征进行匹配
- 区分「点击」和「成交」两个层级

---

## 方法选择决策表

| 业务场景 | 关键特征 | 推荐方法 |
|---------|---------|---------|
| 策略升级（有对照组） | 有时间变化+分组 | DID |
| 补贴/红包效果 | 有用户特征 | PSM |
| 阈值激励 | 有明确cutoff | RDD |
| 城市政策 | 单一处理单位 | 合成控制 |
| 随机实验 | 可严格随机 | AB Test |
| 功能上线 | 渐进式 rollout | DID + AB |
| 渠道对比 | 无时间变化 | PSM |
| 会员权益 | 特征匹配 | PSM |

---

## 输出模板

每个因果推断分析报告应包含：

### 1. 分析摘要
- 业务问题
- 采用方法
- 核心结论（1句话）

### 2. 数据概况
- 样本量
- 时间跨度
- 关键变量统计

### 3. 方法论
- 为什么选择该方法
- 关键假设
- 假设检验结果

### 4. 核心结果
- 效应大小
- 统计显著性
- 置信区间

### 5. 业务建议
- 策略是否有效
- 是否建议推广/优化
- 下一步分析方向

---

## 常见陷阱

| 陷阱 | 说明 | 避免方法 |
|------|------|---------|
| 选择偏差 | 处理组和对照组本身不同 | 用PSM/DID控制 |
| 时间趋势 | 误把趋势当效应 | 用对照组 + DID |
| 幸存者偏差 | 只看留存用户 | 完整样本分析 |
| 短期效应 | 只看近期数据 | 长期跟踪分析 |
| 指标选取 | 用错误指标衡量 | 选择业务相关指标 |
